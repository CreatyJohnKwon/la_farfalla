name: Optimized CI/CD Pipeline

on:
    push:
        branches:
            - main

env:
    NODE_VERSION: "18"
    DEPLOY_DIR: "la_farfalla"

jobs:
    build-and-deploy:
        runs-on: ubuntu-latest

        steps:
            - name: Checkout repository
              uses: actions/checkout@v4

            - name: Setup Node.js with caching
              uses: actions/setup-node@v4
              with:
                  node-version: ${{ env.NODE_VERSION }}
                  cache: "npm"
                  cache-dependency-path: package-lock.json

            - name: Cache node_modules
              uses: actions/cache@v3
              id: npm-cache
              with:
                  path: |
                      ~/.npm
                      node_modules
                      .next/cache
                  key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}-${{ hashFiles('**/*.js', '**/*.jsx', '**/*.ts', '**/*.tsx') }}
                  restore-keys: |
                      ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}-
                      ${{ runner.os }}-node-

            - name: Install dependencies
              if: steps.npm-cache.outputs.cache-hit != 'true'
              run: |
                  echo "ğŸ“¦ Installing dependencies..."
                  npm ci --prefer-offline --no-audit

            - name: Create optimized .env.production
              run: |
                  echo "ğŸ”§ Creating production environment file..."
                  cat > .env.production << EOF
                  NAVER_CLIENT_ID=${{ secrets.NAVER_CLIENT_ID }}
                  NAVER_CLIENT_SECRET=${{ secrets.NAVER_CLIENT_SECRET }}
                  KAKAO_CLIENT_ID=${{ secrets.KAKAO_CLIENT_ID }}
                  KAKAO_CLIENT_SECRET=${{ secrets.KAKAO_CLIENT_SECRET }}
                  NEXTAUTH_SECRET=${{ secrets.NEXTAUTH_SECRET }}
                  NEXTAUTH_URL=${{ secrets.NEXTAUTH_URL }}
                  R2_TOKEN=${{ secrets.R2_TOKEN }}
                  R2_ACCOUNT_ID=${{ secrets.R2_ACCOUNT_ID }}
                  R2_ACCESS_KEY_ID=${{ secrets.R2_ACCESS_KEY_ID }}
                  R2_SECRET_ACCESS_KEY=${{ secrets.R2_SECRET_ACCESS_KEY }}
                  R2_BUCKET_NAME=${{ secrets.R2_BUCKET_NAME }}
                  R2_FILE_DOMAIN=${{ secrets.R2_FILE_DOMAIN }}
                  MONGODB_URI=${{ secrets.MONGODB_URI }}
                  NEXT_IMAGE_OPTIMIZATION_TIMEOUT=${{ secrets.NEXT_IMAGE_OPTIMIZATION_TIMEOUT }}
                  SMTP_HOST=${{ secrets.SMTP_HOST }}
                  SMTP_PORT=${{ secrets.SMTP_PORT }}
                  SMTP_SECURE=${{ secrets.SMTP_SECURE }}
                  SMTP_USER=${{ secrets.SMTP_USER }}
                  SMTP_PASSWORD=${{ secrets.SMTP_PASSWORD }}
                  ADMIN_EMAIL=${{ secrets.ADMIN_EMAIL }}
                  STORE_NAME=${{ secrets.STORE_NAME }}
                  NODE_ENV=production
                  EOF

            - name: Build application locally
              run: |
                  echo "ğŸ—ï¸ Building application..."
                  npm run build
                  echo "âœ… Build completed"

            - name: Create optimized deployment package
              run: |
                  echo "ğŸ“¦ Creating optimized deployment package..."
                  TIMESTAMP=$(date +%Y%m%d_%H%M%S)
                  ARTIFACT_NAME="deploy-${TIMESTAMP}.tar.gz"

                  # ë°°í¬ì— í•„ìš”í•œ íŒŒì¼ë§Œ ì„ ë³„ì ìœ¼ë¡œ í¬í•¨
                  tar -czf "$ARTIFACT_NAME" \
                      --exclude='.git' \
                      --exclude='.github' \
                      --exclude='node_modules' \
                      --exclude='*.log' \
                      --exclude='.next/cache' \
                      --exclude='coverage' \
                      --exclude='tests' \
                      --exclude='*.test.*' \
                      --exclude='*.spec.*' \
                      --exclude='.env.local' \
                      --exclude='.env.development' \
                      --exclude='README.md' \
                      --exclude='.gitignore' \
                      --exclude='docs' \
                      .

                  echo "ARTIFACT_NAME=$ARTIFACT_NAME" >> $GITHUB_ENV

                  # ì••ì¶• ê²°ê³¼ í™•ì¸
                  ORIGINAL_SIZE=$(du -sh . | cut -f1)
                  COMPRESSED_SIZE=$(du -sh "$ARTIFACT_NAME" | cut -f1)
                  echo "ğŸ“Š Original size: $ORIGINAL_SIZE, Compressed: $COMPRESSED_SIZE"

            - name: Set up SSH key with optimization
              run: |
                  echo "ğŸ”‘ Setting up SSH connection..."
                  mkdir -p ~/.ssh
                  echo "$AWS_SSH_KEY" | base64 -d > ~/.ssh/id_rsa
                  chmod 600 ~/.ssh/id_rsa

                  # SSH ì„¤ì • ìµœì í™”
                  cat > ~/.ssh/config << EOF
                  Host ec2-deploy
                      HostName ${{ secrets.EC2_PUBLIC_IP }}
                      User ec2-user
                      IdentityFile ~/.ssh/id_rsa
                      StrictHostKeyChecking no
                      UserKnownHostsFile=/dev/null
                      ServerAliveInterval 60
                      ServerAliveCountMax 3
                      Compression yes
                      TCPKeepAlive yes
                  EOF
              env:
                  AWS_SSH_KEY: ${{ secrets.AWS_SSH_KEY }}

            - name: Optimized file transfer
              run: |
                  echo "ğŸš€ Transferring deployment package..."

                  # ì••ì¶• ì „ì†¡ (ë” ë¹ ë¦„)
                  scp -C -o Compression=yes "${{ env.ARTIFACT_NAME }}" ec2-deploy:/tmp/

                  echo "âœ… Transfer completed"

            - name: Remote deployment with cleanup
              run: |
                  ssh ec2-deploy << 'DEPLOY_SCRIPT'
                    set -e  # ì—ëŸ¬ ì‹œ ì¦‰ì‹œ ì¤‘ë‹¨
                    
                    echo "ğŸ”„ Starting optimized deployment..."
                    
                    # ë³€ìˆ˜ ì„¤ì •
                    DEPLOY_DIR="${{ env.DEPLOY_DIR }}"
                    ARTIFACT_FILE="/tmp/${{ env.ARTIFACT_NAME }}"
                    BACKUP_DIR="${DEPLOY_DIR}_backup_$(date +%H%M%S)"
                    
                    # 1. í—¬ìŠ¤ì²´í¬ í•¨ìˆ˜
                    health_check() {
                        echo "ğŸ¥ Performing health check..."
                        for i in {1..30}; do
                            if docker-compose ps | grep -q "Up"; then
                                echo "âœ… Application is healthy"
                                return 0
                            fi
                            echo "â³ Waiting for application to start... ($i/30)"
                            sleep 2
                        done
                        echo "âŒ Health check failed"
                        return 1
                    }
                    
                    # 2. ë¡¤ë°± í•¨ìˆ˜
                    rollback() {
                        echo "ğŸ”„ Rolling back to previous version..."
                        if [ -d "$BACKUP_DIR" ]; then
                            sudo rm -rf "$DEPLOY_DIR" 2>/dev/null || true
                            mv "$BACKUP_DIR" "$DEPLOY_DIR"
                            cd "$DEPLOY_DIR"
                            docker-compose up -d
                            echo "âœ… Rollback completed"
                        fi
                    }
                    
                    # 3. ê¸°ì¡´ ì„œë¹„ìŠ¤ ì•ˆì „ ì¢…ë£Œ ë° ë°±ì—…
                    if [ -d "$DEPLOY_DIR" ]; then
                        echo "ğŸ›‘ Gracefully stopping existing services..."
                        cd "$DEPLOY_DIR"
                        docker-compose down --timeout 30 || true
                        cd /home/ec2-user
                        
                        # ë¹ ë¥¸ ë°±ì—… (ë§í¬ ì‚¬ìš©)
                        echo "ğŸ’¾ Creating backup..."
                        mv "$DEPLOY_DIR" "$BACKUP_DIR" 2>/dev/null || sudo mv "$DEPLOY_DIR" "$BACKUP_DIR"
                    fi
                    
                    # 4. Docker ë¦¬ì†ŒìŠ¤ ì •ë¦¬ (ë³‘ë ¬ ì‹¤í–‰)
                    echo "ğŸ§¹ Cleaning Docker resources..."
                    {
                        docker container prune -f
                        docker image prune -f
                        docker network prune -f
                    } &
                    
                    # 5. ìƒˆ ë°°í¬ ë””ë ‰í† ë¦¬ ìƒì„±
                    echo "ğŸ“ Setting up new deployment..."
                    mkdir -p "$DEPLOY_DIR"
                    cd "$DEPLOY_DIR"
                    
                    # 6. ë¹ ë¥¸ ì••ì¶• í•´ì œ
                    echo "ğŸ“¦ Extracting deployment package..."
                    tar -xzf "$ARTIFACT_FILE" --no-same-owner
                    
                    # 7. ì„ì‹œ íŒŒì¼ ì •ë¦¬
                    rm -f "$ARTIFACT_FILE"
                    
                    # 8. Docker ë¹Œë“œ ë° ì‹œì‘ (ìºì‹œ í™œìš©)
                    echo "ğŸš€ Starting new deployment..."
                    if ! docker-compose up -d --build; then
                        echo "âŒ Deployment failed"
                        rollback
                        exit 1
                    fi
                    
                    # 9. í—¬ìŠ¤ì²´í¬
                    if ! health_check; then
                        echo "âŒ Health check failed, rolling back..."
                        rollback
                        exit 1
                    fi
                    
                    # 10. ë°±ì—… ì •ë¦¬ (ì„±ê³µ ì‹œì—ë§Œ)
                    echo "ğŸ§¹ Cleaning up old backups..."
                    sudo rm -rf "$BACKUP_DIR" 2>/dev/null || true
                    
                    # 11. ìµœì¢… ìƒíƒœ í™•ì¸
                    echo "ğŸ“Š Final status check..."
                    docker-compose ps
                    docker system df
                    
                    # 12. ì˜¤ë˜ëœ ì•„í‹°íŒ©íŠ¸ ì •ë¦¬
                    find /tmp -name "deploy-*.tar.gz" -mtime +1 -delete 2>/dev/null || true
                    
                    echo "âœ… Deployment completed successfully!"
                    echo "ğŸŒ Application is available at: ${{ secrets.NEXTAUTH_URL }}"
                    echo "ğŸ“ˆ Memory usage: $(free -h | awk 'NR==2{printf "%.1f%%", $3*100/$2}')"
                    echo "ğŸ’¾ Disk usage: $(df -h / | awk 'NR==2{print $5}')"
                  DEPLOY_SCRIPT

            - name: Cleanup local artifacts
              if: always()
              run: |
                  echo "ğŸ§¹ Cleaning up local artifacts..."
                  rm -f ${{ env.ARTIFACT_NAME }} 2>/dev/null || true

            - name: Deployment success notification
              if: success()
              run: |
                  echo "âœ… ğŸ‰ Deployment completed successfully!"
                  echo "ğŸš€ Build time optimization achieved with caching"
                  echo "ğŸ“¦ Optimized package deployment completed"
                  echo "ğŸŒ Application URL: ${{ secrets.NEXTAUTH_URL }}"
                  echo "ğŸ“Š Deployment metrics:"
                  echo "  - Cache hit: ${{ steps.npm-cache.outputs.cache-hit }}"
                  echo "  - Build completed at: $(date)"

            - name: Deployment failure notification
              if: failure()
              run: |
                  echo "âŒ ğŸš¨ Deployment failed!"
                  echo "ğŸ” Please check the logs above for details"
                  echo "ğŸ”„ Automatic rollback should have been triggered"
                  echo "ğŸ’¡ Troubleshooting tips:"
                  echo "  1. Check SSH connection to EC2"
                  echo "  2. Verify environment variables"
                  echo "  3. Check Docker container logs"
                  echo "  4. Verify disk space on EC2"
                  exit 1
